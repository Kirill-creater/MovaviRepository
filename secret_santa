from telebot import TeleBot,types
import sqlite3
import random
import tocken

bot = TeleBot(tocken.TOKEN)

def choose_for_santa(message:types.Message):
    connection = sqlite3.connect("database.db")
    cur = connection.execute(
        """
        UPDATE santa
        SET santa_for = 0
        """
    )
    connection.commit()
    cur = connection.execute(
        f"""
        SELECT * 
        FROM santa
        """
    )
    members_list = cur.fetchall()
    random.shuffle(members_list)
    last = None
    first = None
    for obj in members_list:
        # print(f'{last},{obj}')
        if last == None:
            first = obj
            last = obj
            continue
        if last == obj:
            continue
        cur = connection.execute(
            f"""
            UPDATE santa
            SET santa_for = {obj[0]}
            WHERE user_name = '{last[2]}'
            """
        )
        print(f"{last[2],obj[0]}")
        connection.commit()
        # members_list.remove(last)
        last = obj
    cur = connection.execute(
    f"""
    UPDATE santa
    SET santa_for = {first[0]}
    WHERE user_name = '{last[2]}'
    """
    )
    connection.commit()
    connection.close()
    connection = sqlite3.connect("database.db")
    cur = connection.execute(
        f"""
        SELECT * 
        FROM santa
        """
    )
    for obj in cur.fetchall():
        print(obj)
def comands(message:types.Message):
    keyboard = types.InlineKeyboardMarkup()
    register_button = types.InlineKeyboardButton(text='Регистрация',callback_data='register')
    members_button = types.InlineKeyboardButton(text='Участники',callback_data='members')
    santa_for_button = types.InlineKeyboardButton(text='Чей я Санта?',callback_data='santa_for')
    keyboard.add(register_button)
    keyboard.add(members_button)
    keyboard.add(santa_for_button)
    bot.send_message(chat_id=message.chat.id,text='Доступные команды:',reply_markup=keyboard)

def reg(message:types.Message):
    connection = sqlite3.connect("database.db")
    cur = connection.execute(
        f"""
        INSERT INTO santa(user_id,user_name,wishes,santa_for)
            VALUES ({message.chat.id},'{message.text.strip()}','0',0)
        """
    )
    connection.commit()
    connection.close()
    bot.send_message(chat_id=message.chat.id,text='Введите ваши пожелания что бы вы хотели получить ✨')
    bot.register_next_step_handler(message,wish_reg)
def wish_reg(message:types.Message):
    connection = sqlite3.connect("database.db")
    cur = connection.execute(
        f"""
        UPDATE santa
            SET wishes = '{message.text}'
            WHERE user_id = '{message.chat.id}'
        """ 
    )
    connection.commit()
    connection.close()
    bot.send_message(chat_id=message.chat.id,text='Вы участвуете!!!')
    comands(message)


@bot.message_handler(commands=['start'])
def start(message:types.Message):
    connection = sqlite3.connect("database.db")
    cur = connection.execute(
        f"""
        CREATE TABLE IF NOT EXISTS santa(
            id INTEGER PRIMARY KEY,
            user_id INT,
            user_name TEXT,
            wishes TEXT,
            santa_for INT
        )
        """
    )
    keyboard = types.InlineKeyboardMarkup()
    register_button = types.InlineKeyboardButton(text='Регистрация',callback_data='register')
    members_button = types.InlineKeyboardButton(text='Участники',callback_data='members')
    santa_for_button = types.InlineKeyboardButton(text='Чей я Санта?',callback_data='santa_for')
    keyboard.add(register_button)
    keyboard.add(members_button)
    keyboard.add(santa_for_button)
    bot.send_message(chat_id=message.chat.id,text='Привет я бот "Тайный Санта" помогаю распределять участников между собой!',reply_markup=keyboard)

@bot.message_handler(commands=['help'])
def help(message:types.Message):
    bot.send_message(chat_id=message.chat.id,text='Help!')

@bot.message_handler()
def message(message:types.Message):
    if message.text == '/start_choose 54321':
        choose_for_santa(message)
        return
    bot.send_message(chat_id=message.chat.id,text='Hello!')

@bot.callback_query_handler(lambda callback : True)
def callback_handler(callback:types.CallbackQuery):
    if callback.data == 'register':
        print(1)
        connection = sqlite3.connect("database.db")
        cur = connection.execute(
            f"""
            SELECT user_id,user_name 
            FROM santa
            WHERE user_id = {callback.message.chat.id} 
            """
            #             WHERE user_id = {callback.message.chat.id} 
        )
        if len(cur.fetchall()) == 0:
            bot.send_message(chat_id=callback.message.chat.id,text='Введите ваше имя')
            bot.register_next_step_handler(callback.message,reg)
        else:
            bot.send_message(chat_id=callback.message.chat.id,text='вы уже зарегистрированы!')
            comands(callback.message)
        connection.close()
    elif callback.data == 'members':
        connection = sqlite3.connect("database.db")
        cur = connection.execute(
            f"""
            SELECT id,user_name ,user_id
            FROM santa
            """
        )
        answer = "Все участники:\n"
        for obj in cur.fetchall():
            answer += f"{obj[0]}. {obj[1]}"
            if obj[2] == callback.message.chat.id:
                answer += ' (вы)\n'
            else:
                answer += '\n'
        bot.send_message(chat_id=callback.message.chat.id,text=answer)
        connection.close()   
    elif callback.data == 'santa_for':
        connection = sqlite3.connect("database.db")
        cur = connection.execute(
            f"""
            SELECT * 
            FROM santa
            """
        )
        for obj in cur.fetchall():
            bot.send_message(chat_id=callback.message.chat.id,text=str(obj))
        connection.close()
print('starting...')
bot.polling(non_stop=True,interval=1)
